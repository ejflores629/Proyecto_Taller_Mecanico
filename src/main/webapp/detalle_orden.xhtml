<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="jakarta.faces.html"
      xmlns:f="jakarta.faces.core"
      xmlns:p="http://primefaces.org/ui">

<f:metadata>
    <f:viewParam name="orden" value="#{detalleBean.numeroOrdenParam}"/>
    <f:viewAction action="#{detalleBean.cargarDatos}"/>
</f:metadata>

<h:head>
    <title>Detalle de Orden #{detalleBean.numeroOrdenParam}</title>
    <style>
        body { background-color: #f8f9fa; font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif; color: #495057; }
        .header-card { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid #00688C; }
        .header-info h2 { margin: 0; color: #2c3e50; }
        .header-info p { margin: 5px 0 0; color: #6c757d; font-size: 1.1rem; }
        .costo-box { text-align: right; }
        .costo-label { font-size: 0.9rem; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        .costo-valor { font-size: 2.5rem; font-weight: 800; color: #28a745; margin: 0; }
        .tab-custom .ui-tabs-nav { background: transparent !important; border-bottom: 2px solid #e9ecef !important; }
        .tab-custom .ui-tabs-panel { padding: 20px 0 !important; }
    </style>
</h:head>

<h:body>
    <h:form id="formDetalle">
        <p:growl id="msgs" showDetail="true" life="4000"/>

        <div class="header-card">
            <div class="header-info">
                <h2>Orden: #{detalleBean.ordenActual.numero_orden}</h2>
                <p>
                    <i class="pi pi-car"/> <strong>#{detalleBean.ordenActual.vehiculo}</strong>
                    | <i class="pi pi-user"/> #{detalleBean.ordenActual.cliente}
                </p>
                <span style="display:inline-block; margin-top:8px; padding: 4px 10px; background:#eee; border-radius:4px; font-size:0.9rem;">
                    Estado: <strong>#{detalleBean.ordenActual.estado}</strong>
                </span>
            </div>
            <div class="costo-box">
                <div class="costo-label">Costo Total Acumulado</div>
                <div class="costo-valor">
                    <h:outputText value="#{detalleBean.ordenActual.costo_total}">
                        <f:convertNumber type="currency" currencySymbol="L." locale="es_HN"/>
                    </h:outputText>
                </div>
                <p:button value="Volver a Lista" icon="pi pi-arrow-left" outcome="orden.xhtml"
                          styleClass="ui-button-secondary ui-button-outlined" style="margin-top:10px;"/>
            </div>
        </div>

        <p:tabView styleClass="tab-custom">

            <p:tab title="Materiales y Repuestos">
                <div style="display: flex; gap: 20px;">
                    <p:card style="width: 350px;">
                        <f:facet name="title">Agregar Repuesto</f:facet>
                        <div class="ui-fluid">
                            <div class="field">
                                <p:outputLabel value="Seleccionar Repuesto"/>
                                <p:selectOneMenu value="#{detalleBean.nuevoRepuesto.codigo_sku}"
                                                 filter="true" filterMatchMode="contains" required="true">
                                    <f:selectItem itemLabel="-- Seleccione --" itemValue=""/>
                                    <f:selectItems value="#{detalleBean.inventarioRepuestos}" var="r"
                                                   itemLabel="#{r.nombre} (Disp: #{r.stock_actual})"
                                                   itemValue="#{r.codigo_sku}"/>
                                </p:selectOneMenu>
                            </div>
                            <div class="field" style="margin-top:15px;">
                                <p:outputLabel value="Cantidad"/>
                                <p:spinner value="#{detalleBean.nuevoRepuesto.cantidad_utilizada}" min="1" required="true"/>
                            </div>
                            <p:commandButton value="Agregar al Carrito" icon="pi pi-cart-plus"
                                             action="#{detalleBean.agregarRepuesto}"
                                             update="@form" style="margin-top:15px;"/>
                        </div>
                    </p:card>

                    <p:dataTable value="#{detalleBean.listaRepuestosAgregados}" var="item" style="flex: 1;">
                        <p:column headerText="Repuesto">
                            <h:outputText value="#{item.repuesto}"/>
                            <br/><small>SKU: #{item.codigo_sku}</small>
                        </p:column>
                        <p:column headerText="Cant." width="80" style="text-align: center;">
                            #{item.cantidad_utilizada}
                        </p:column>
                        <p:column headerText="Precio Unit." width="120" style="text-align: right;">
                            <h:outputText value="#{item.precio_venta_momento}">
                                <f:convertNumber type="currency" currencySymbol="L."/>
                            </h:outputText>
                        </p:column>
                        <p:column headerText="Subtotal" width="120" style="text-align: right; font-weight:bold;">
                            <h:outputText value="#{item.subtotal}">
                                <f:convertNumber type="currency" currencySymbol="L."/>
                            </h:outputText>
                        </p:column>
                        <p:column width="60" style="text-align: center;">
                            <p:commandButton icon="pi pi-trash" styleClass="ui-button-danger ui-button-flat rounded-button"
                                             action="#{detalleBean.eliminarRepuesto(item.codigo_sku)}" update="@form">
                                <p:confirm header="Quitar" message="¿Quitar este repuesto?" icon="pi pi-exclamation-triangle"/>
                            </p:commandButton>
                        </p:column>
                    </p:dataTable>
                </div>
            </p:tab>

            <p:tab title="Mano de Obra y Servicios">
                <div style="display: flex; gap: 20px;">
                    <p:card style="width: 350px;">
                        <f:facet name="title">Asignar Tarea</f:facet>
                        <div class="ui-fluid">
                            <div class="field">
                                <p:outputLabel value="Técnico Responsable"/>
                                <p:selectOneMenu value="#{detalleBean.nuevaManoObra.doc_tecnico}"
                                                 filter="true" required="true">
                                    <f:selectItem itemLabel="-- Seleccione --" itemValue=""/>
                                    <f:selectItems value="#{detalleBean.listaTecnicos}" var="t"
                                                   itemLabel="#{t.nombre_completo}" itemValue="#{t.doc_identidad}"/>
                                </p:selectOneMenu>
                            </div>
                            <div class="field" style="margin-top:15px;">
                                <p:outputLabel value="Descripción Tarea"/>
                                <p:inputText value="#{detalleBean.nuevaManoObra.descripcion_tarea}" required="true"/>
                            </div>
                            <div class="field" style="margin-top:15px;">
                                <p:outputLabel value="Costo Mano de Obra (L.)"/>
                                <p:inputNumber value="#{detalleBean.nuevaManoObra.costo_mano_obra}"
                                               symbol="L. " symbolPosition="p" minValue="0" required="true"/>
                            </div>
                            <div class="field" style="margin-top:15px;">
                                <p:outputLabel value="Horas Estimadas"/>
                                <p:inputNumber value="#{detalleBean.nuevaManoObra.tiempo_estimado_hrs}" decimalPlaces="1"/>
                            </div>
                            <p:commandButton value="Asignar Tarea" icon="pi pi-user-plus"
                                             action="#{detalleBean.agregarManoObra}"
                                             update="@form" styleClass="ui-button-warning" style="margin-top:15px;"/>
                        </div>
                    </p:card>

                    <p:dataTable value="#{detalleBean.listaManoObraAgregada}" var="mo" style="flex: 1;">
                        <p:column headerText="Descripción Tarea">
                            <h:outputText value="#{mo.descripcion_tarea}" style="font-weight:bold;"/>
                            <br/><small>Técnico: #{mo.tecnico}</small>
                        </p:column>
                        <p:column headerText="Horas" width="80" style="text-align: center;">
                            #{mo.tiempo_estimado_hrs} h
                        </p:column>
                        <p:column headerText="Costo" width="120" style="text-align: right; font-weight:bold;">
                            <h:outputText value="#{mo.costo_mano_obra}">
                                <f:convertNumber type="currency" currencySymbol="L."/>
                            </h:outputText>
                        </p:column>
                        <p:column width="60" style="text-align: center;">
                            <p:commandButton icon="pi pi-trash" styleClass="ui-button-danger ui-button-flat rounded-button"
                                             action="#{detalleBean.eliminarManoObra(mo.id_detalle)}" update="@form">
                                <p:confirm header="Eliminar" message="¿Eliminar esta tarea?" icon="pi pi-exclamation-triangle"/>
                            </p:commandButton>
                        </p:column>
                    </p:dataTable>
                </div>
            </p:tab>

        </p:tabView>

        <p:confirmDialog global="true" showEffect="fade" hideEffect="fade" responsive="true" width="350">
            <p:commandButton value="No" type="button" styleClass="ui-confirmdialog-no ui-button-flat"/>
            <p:commandButton value="Sí" type="button" styleClass="ui-confirmdialog-yes ui-button-danger" />
        </p:confirmDialog>
    </h:form>
</h:body>
</html>